-- 1.write a query to print top 5 cities with highest spends and their percentage contribution of total credit card spends 

with cte as (
select city,sum(amount) as total_spend
from credit_card_transactions
group by city)
,total_spent as (select sum(amount) as total_amount from credit_card_transactions)
select cte.*, round(total_spend*1.0/total_amount * 100,2) as percentage_contribution from 
cte inner join total_spent on 1=1
order by total_spend desc
limit 5;

-- 2. write a query to print highest spend month and amount spent in that month for each card type
with cte as (
select card_type, year(transaction_date) yt,
month(transaction_date) mt,sum(amount) as total_spend
from credit_card_transactions
group by card_type,year(transaction_date),month(transaction_date)
order by card_type,total_spend desc)

select * from (select *, rank() over(partition by card_type order by total_spend desc) as rn
from cte) a where rn=1;

-- 3.write a query to print the transaction details(all columns from the table) for each card type when it reaches a cumulative of  1,000,000 total spends(We should have 4 rows in the o/p one for each card type)

with cte as (
select *,sum(amount) over(partition by card_type order by transaction_date,transaction_id) as total_spend
from credit_card_transactions
order by card_type,total_spend desc
)
select * from (select *, rank() over(partition by card_type order by total_spend) as rn  
from cte where total_spend >= 1000000) a where rn=1;

-- 4.write a query to find city which had lowest percentage spend for gold card type
with cte as (
select city,card_type,sum(amount) as amount
,sum(case when card_type='Gold' then amount end) as gold_amount
from credit_card_transactions
group by city,card_type)
select 
city,sum(gold_amount)*1.0/sum(amount) as gold_ratio
from cte
group by city
having count(gold_amount) > 0 and sum(gold_amount)>0
order by gold_ratio
limit 1;

-- 6. write a query to find percentage contribution of spends by females for each expense type
select exp_type,
sum(case when gender='F' then amount else 0 end)*1.0/sum(amount) as percentage_female_contribution
from credit_card_transactions
group by exp_type
order by percentage_female_contribution desc;

-- 7. which card and expense type combination saw highest month over month growth in Jan-2014
with cte as (
select card_type,exp_type, year(transaction_date) yt,
month(transaction_date) mt,sum(amount) as total_spend
from credit_card_transactions
group by card_type,exp_type, year(transaction_date), month(transaction_date)
)
select total_spend-prev_mont_spend as mom_growth
from (
select *
,lag(total_spend,1) over(partition by card_type,exp_type order by yt,mt) as prev_mont_spend
from cte) A
where prev_mont_spend is not null and yt=2014 and mt=1
order by mom_growth desc
limit 1;
 
 -- 8. during weekends which city has highest total spend to total no of transcations ratio 
SELECT city,
SUM(amount) * 1.0 / COUNT(*) AS ratio
FROM credit_card_transactions
WHERE DAYNAME(transaction_date) IN ('Saturday', 'Sunday')
GROUP BY city
ORDER BY ratio DESC;

-- 9.which city took least number of days to reach its 500th transaction after the first transaction in that city;

WITH cte AS (
SELECT city, transaction_date,
	ROW_NUMBER() OVER (PARTITION BY city ORDER BY transaction_date, transaction_id) AS rn
    FROM credit_card_transactions
)
SELECT city,
DATEDIFF(MAX(transaction_date), MIN(transaction_date)) AS days_to_500
FROM cte
WHERE rn IN (1, 500)
GROUP BY city
HAVING COUNT(*) = 2
ORDER BY days_to_500
LIMIT 1;
